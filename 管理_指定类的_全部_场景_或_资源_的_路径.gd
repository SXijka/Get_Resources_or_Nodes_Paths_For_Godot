## æä¾›ç”¨äºç®¡ç†å’Œæ“ä½œç»§æ‰¿è‡ªæŒ‡å®šç±»çš„åœºæ™¯æˆ–èµ„æºçš„ç¼–è¾‘å™¨ä¸‹æ–‡ä»¶è·¯å¾„æˆ–æŒ‡å®šèµ·å§‹èŠ‚ç‚¹ä¸‹èŠ‚ç‚¹è·¯å¾„çš„å·¥å…·æ–¹æ³•ã€‚
## æ³¨æ„ï¼š è¯¥å·¥å…·ä»…é€‚ç”¨äºæ–‡ä»¶åä¸ç±»åä¸€è‡´çš„ç±»ã€‚
## æ³¨æ„ï¼š ç±»åå¤§å°å†™æ•æ„Ÿï¼Œå¤§å°å†™é”™è¯¯ä¼šç›´æ¥å¯¼è‡´ç»§æ‰¿æ£€æŸ¥å¤±è´¥ã€‚
class_name ç®¡ç†_æŒ‡å®šç±»çš„_å…¨éƒ¨_åœºæ™¯_æˆ–_èµ„æº_çš„_è·¯å¾„

const æ¯å¸§_æ“ä½œæ¬¡æ•°:=42
const æ‰«ææ—¶_å¿½ç•¥éšè—ç›®å½•:= true


#region ä¸»è¦æ–¹æ³•

static func æ‰“å°_æŒ‡å®šç›®å½•ä¸‹_æŒ‡å®šç±»_åŠå…¶æ´¾ç”Ÿç±»_æ–‡ä»¶çš„_è·¯å¾„(ç±»å: String, æ˜¯_åœºæ™¯: bool = true, æ£€æŸ¥æ ¹ç›®å½•: String = "res://"):
	if ç±»å.is_empty():
		push_warning("è¯·å…ˆè®¾ç½®è¦æŸ¥æ‰¾çš„ç±»å")
		return
	
	var æ–‡ä»¶åˆ—è¡¨ = è·å–_æŒ‡å®šç›®å½•ä¸‹_æŒ‡å®šç±»_åŠå…¶æ´¾ç”Ÿç±»_æ–‡ä»¶çš„_è·¯å¾„(ç±»å, æ˜¯_åœºæ™¯,æ£€æŸ¥æ ¹ç›®å½•)
	if æ–‡ä»¶åˆ—è¡¨.is_empty():
		print("æœªæ‰¾åˆ°ç»§æ‰¿è‡ª %s çš„ %s æ–‡ä»¶" % [ç±»å, ".tscn" if æ˜¯_åœºæ™¯ else ".tres"])
	else:
		print("æ‰¾åˆ° %d ä¸ªç»§æ‰¿è‡ª %s çš„ %s æ–‡ä»¶:" % [æ–‡ä»¶åˆ—è¡¨.size(), ç±»å, ".tscn" if æ˜¯_åœºæ™¯ else ".tres"])
		for æ–‡ä»¶è·¯å¾„ in æ–‡ä»¶åˆ—è¡¨:
			print(" - ", æ–‡ä»¶è·¯å¾„)

# ä¿å­˜ä¸ºJSONæ–‡ä»¶åŠŸèƒ½
static func ä¿å­˜ä¸º_JSONæ–‡ä»¶(ç±»å: String, æ˜¯_åœºæ™¯: bool = true, æ–‡ä»¶å_å»é™¤_åç¼€: bool = true, ä¿å­˜æ–‡ä»¶å: String ="", ä¿å­˜ç›®å½•: String = "", æ£€æŸ¥æ ¹ç›®å½•: String = "res://"):
	if ç±»å == null or ç±»å.is_empty():
		push_error("è·å–_æ‰€æœ‰æ´¾ç”Ÿç±»æ–‡ä»¶çš„_è·¯å¾„å¤±è´¥: å‚æ•°'åŸºç±»'ä¸ºnullæˆ–ç©ºå­—ç¬¦ä¸²")
	if ä¿å­˜æ–‡ä»¶å == null or ä¿å­˜æ–‡ä»¶å.is_empty():
		push_error("è·å–_æ‰€æœ‰æ´¾ç”Ÿç±»æ–‡ä»¶çš„_è·¯å¾„å¤±è´¥: å‚æ•°'ä¿å­˜æ–‡ä»¶å'ä¸ºnullæˆ–ç©ºå­—ç¬¦ä¸²")
	if ä¿å­˜ç›®å½• == null or ä¿å­˜ç›®å½•.is_empty():
		push_error("è·å–_æ‰€æœ‰æ´¾ç”Ÿç±»æ–‡ä»¶çš„_è·¯å¾„å¤±è´¥: å‚æ•°'ä¿å­˜ç›®å½•'ä¸ºnullæˆ–ç©ºå­—ç¬¦ä¸²")
	
	if not DirAccess.dir_exists_absolute(ä¿å­˜ç›®å½•):
		push_error("æ–‡ä»¶å°†ä¿å­˜åˆ°çš„ç›®å½•å¹¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆè®¾ç½®è¦ä¿å­˜çš„ä½ç½®")
		return
	if ç±»å.is_empty():
		push_warning("è¯·å…ˆè®¾ç½®è¦æŸ¥æ‰¾çš„ç±»å")
		return
	
	var æ–‡ä»¶åˆ—è¡¨ = è·å–_æŒ‡å®šç›®å½•ä¸‹_æŒ‡å®šç±»_åŠå…¶æ´¾ç”Ÿç±»_æ–‡ä»¶çš„_è·¯å¾„(ç±»å, æ˜¯_åœºæ™¯, æ£€æŸ¥æ ¹ç›®å½•)
	if æ–‡ä»¶åˆ—è¡¨.is_empty():
		push_warning("æœªæ‰¾åˆ°å¯ä¿å­˜çš„æ–‡ä»¶")
		return
	
	var è·¯å¾„å­—å…¸ = {}
	for æ–‡ä»¶è·¯å¾„ in æ–‡ä»¶åˆ—è¡¨:
		var æ–‡ä»¶å = æ–‡ä»¶è·¯å¾„.get_file()
		# æ ¹æ®è®¾ç½®å¤„ç†æ–‡ä»¶å
		if æ–‡ä»¶å_å»é™¤_åç¼€:  # å»é™¤åç¼€
			æ–‡ä»¶å = æ–‡ä»¶å.get_basename()
		è·¯å¾„å­—å…¸[æ–‡ä»¶å] = æ–‡ä»¶è·¯å¾„
	
	var ä¿å­˜è·¯å¾„ = ä¿å­˜ç›®å½•.path_join(ä¿å­˜æ–‡ä»¶å)
	var æ–‡ä»¶ = FileAccess.open(ä¿å­˜è·¯å¾„, FileAccess.WRITE)
	if æ–‡ä»¶:
		æ–‡ä»¶.store_string(JSON.stringify(è·¯å¾„å­—å…¸, "\t"))
		æ–‡ä»¶.close()
		print("æ–‡ä»¶è·¯å¾„å­—å…¸å·²ä¿å­˜åˆ°: %s" % ä¿å­˜è·¯å¾„)
	else:
		push_error("æ— æ³•ä¿å­˜æ–‡ä»¶åˆ°: %s" % ä¿å­˜è·¯å¾„)


## è·å–åœºæ™¯ä¸­æ‰€æœ‰ç»§æ‰¿è‡ªæŒ‡å®šç±»çš„èŠ‚ç‚¹è·¯å¾„
## å‚æ•°ï¼š
##   - åŸºç±»å: è¦æŸ¥æ‰¾çš„åŸºç±»åç§°ï¼ˆStringï¼‰
##   - åœºæ™¯æ ¹èŠ‚ç‚¹: ä»å“ªä¸ªèŠ‚ç‚¹å¼€å§‹æœç´¢ï¼ˆNodeï¼‰ï¼Œé»˜è®¤ä¸ºå½“å‰åœºæ™¯æ ¹
##   - ç‰¹å®šè·¯å¾„: åªæœç´¢è¯¥èŠ‚ç‚¹è·¯å¾„ä¸‹çš„å­èŠ‚ç‚¹ï¼ˆStringï¼‰ï¼Œé»˜è®¤ä¸ºç©ºè¡¨ç¤ºå…¨åœºæ™¯
## è¿”å›ï¼šåŒ…å«æ‰€æœ‰åŒ¹é…èŠ‚ç‚¹è·¯å¾„çš„æ•°ç»„ï¼ˆArray[String]ï¼‰
static func è·å–_æŒ‡å®šèŠ‚ç‚¹ä¸‹_æ‰€æœ‰_æŒ‡å®šç±»_åŠå…¶æ´¾ç”Ÿç±»_èŠ‚ç‚¹çš„_è·¯å¾„(åŸºç±»å: String, èµ·å§‹èŠ‚ç‚¹: Node) -> Array[String]:
	var ç»“æœè·¯å¾„æ•°ç»„: Array[String] = []
	
	if not èµ·å§‹èŠ‚ç‚¹:
		push_error("èµ·å§‹èŠ‚ç‚¹ä¸º nullï¼Œè¯·æ£€æŸ¥è¾“å…¥")
		return ç»“æœè·¯å¾„æ•°ç»„

	# é€’å½’éå†åœºæ™¯æ ‘
	var _éå†èŠ‚ç‚¹ :=(
		func(å½“å‰èŠ‚ç‚¹: Node, é€’å½’è‡ªèº«: Callable):
			if _æ£€æŸ¥_åœºæ™¯_ç»§æ‰¿é“¾(å½“å‰èŠ‚ç‚¹, åŸºç±»å):
				var èŠ‚ç‚¹è·¯å¾„ = å½“å‰èŠ‚ç‚¹.get_path()
				ç»“æœè·¯å¾„æ•°ç»„.append(str(èŠ‚ç‚¹è·¯å¾„))

			for å­èŠ‚ç‚¹ in å½“å‰èŠ‚ç‚¹.get_children():
				é€’å½’è‡ªèº«.call(å­èŠ‚ç‚¹, é€’å½’è‡ªèº«)
			)

	_éå†èŠ‚ç‚¹.call(èµ·å§‹èŠ‚ç‚¹, _éå†èŠ‚ç‚¹)
	return ç»“æœè·¯å¾„æ•°ç»„


## è·å–æŒ‡å®šæ ¹ç›®å½•ï¼ˆé»˜è®¤ä¸ºâ€œres://â€æ–‡ä»¶å¤¹ï¼‰ä¸‹æ‰€æœ‰ç»§æ‰¿è‡ªæŒ‡å®šç±»çš„æ–‡ä»¶ã€‚
## æ˜¯_åœºæ™¯ ä¸ºtrueæ—¶ï¼ŒæŸ¥è¯¢åœºæ™¯(PackedScene)ï¼Œå¦åˆ™æŸ¥è¯¢èµ„æº(Resource)ï¼Œä¸å¯æ··æ·†ã€‚
static func è·å–_æŒ‡å®šç›®å½•ä¸‹_æŒ‡å®šç±»_åŠå…¶æ´¾ç”Ÿç±»_æ–‡ä»¶çš„_è·¯å¾„(åŸºç±»: String, æ˜¯_åœºæ™¯: bool = true, æ ¹ç›®å½•: String = "res://") -> Array[String]:
	if åŸºç±» == null or åŸºç±».is_empty():
		push_error("è·å–_æ‰€æœ‰æ´¾ç”Ÿç±»æ–‡ä»¶çš„_è·¯å¾„å¤±è´¥: å‚æ•°'åŸºç±»'ä¸ºnullæˆ–ç©ºå­—ç¬¦ä¸²")
	
	var ç»“æœ: Array[String] = []
	var æ–‡ä»¶åˆ—è¡¨: Array[String] = []
	
	# é€’å½’æ‰«ææŒ‡å®šçš„æ ¹ç›®å½•(é»˜è®¤ä¸ºâ€œres://â€ç›®å½•)
	_æ‰«æç›®å½•(æ ¹ç›®å½•, æ–‡ä»¶åˆ—è¡¨)
	
	for æ–‡ä»¶_è·¯å¾„ in æ–‡ä»¶åˆ—è¡¨:
		if (æ˜¯_åœºæ™¯ and !æ–‡ä»¶_è·¯å¾„.ends_with(".tscn")) or (!æ˜¯_åœºæ™¯ and !æ–‡ä»¶_è·¯å¾„.ends_with(".tres")):
			continue
			
		var èµ„æº = ResourceLoader.load(æ–‡ä»¶_è·¯å¾„)
		if not èµ„æº:
			continue
			
		# å¤„ç†åœºæ™¯æ–‡ä»¶
		if æ˜¯_åœºæ™¯ and èµ„æº is PackedScene:
			var å®ä¾‹ = èµ„æº.instantiate()
			if _æ£€æŸ¥_åœºæ™¯_ç»§æ‰¿é“¾(å®ä¾‹, åŸºç±»):
				ç»“æœ.append(æ–‡ä»¶_è·¯å¾„)
			å®ä¾‹.queue_free()
		
		# å¤„ç†èµ„æºæ–‡ä»¶
		elif !æ˜¯_åœºæ™¯ and èµ„æº is Resource:
			if _æ£€æŸ¥_èµ„æº_ç»§æ‰¿é“¾(èµ„æº, åŸºç±»):
				ç»“æœ.append(æ–‡ä»¶_è·¯å¾„)

	return ç»“æœ

#endregion


#region å¼‚æ­¥æ–¹æ³•

static func å¼‚æ­¥_æ‰“å°_æŒ‡å®šç›®å½•ä¸‹_æŒ‡å®šç±»_åŠå…¶æ´¾ç”Ÿç±»_æ–‡ä»¶çš„_è·¯å¾„(ç±»å: String, æ˜¯_åœºæ™¯: bool = true, æ£€æŸ¥æ ¹ç›®å½•: String = "res://"):
	if ç±»å.is_empty():
		push_warning("è¯·å…ˆè®¾ç½®è¦æŸ¥æ‰¾çš„ç±»å")
		return

	var æ–‡ä»¶åˆ—è¡¨ = await å¼‚æ­¥_è·å–_æŒ‡å®šç›®å½•ä¸‹_æŒ‡å®šç±»_åŠå…¶æ´¾ç”Ÿç±»_æ–‡ä»¶çš„_è·¯å¾„(ç±»å, æ˜¯_åœºæ™¯, æ£€æŸ¥æ ¹ç›®å½•)
	if æ–‡ä»¶åˆ—è¡¨.is_empty():
		print("æœªæ‰¾åˆ°ç»§æ‰¿è‡ª %s çš„ %s æ–‡ä»¶" % [ç±»å, ".tscn" if æ˜¯_åœºæ™¯ else ".tres"])
	else:
		print("æ‰¾åˆ° %d ä¸ªç»§æ‰¿è‡ª %s çš„ %s æ–‡ä»¶:" % [æ–‡ä»¶åˆ—è¡¨.size(), ç±»å, ".tscn" if æ˜¯_åœºæ™¯ else ".tres"])
		for i in æ–‡ä»¶åˆ—è¡¨.size():
			print(" - ", æ–‡ä»¶åˆ—è¡¨[i])
			if i % æ¯å¸§_æ“ä½œæ¬¡æ•° == 0:
				await HistoriaRivero.å¸§_æ›´æ–°


static func å¼‚æ­¥_æ‰“å°_æŒ‡å®šèŠ‚ç‚¹ä¸‹_æ‰€æœ‰_æŒ‡å®šç±»_åŠå…¶æ´¾ç”Ÿç±»_èŠ‚ç‚¹çš„_è·¯å¾„(ç±»å: String, èµ·å§‹èŠ‚ç‚¹: Node):
	if ç±»å.is_empty():
		push_warning("è¯·å…ˆè®¾ç½®è¦æŸ¥æ‰¾çš„ç±»å")
		return

	var _èŠ‚ç‚¹è·¯å¾„åˆ—è¡¨ := await å¼‚æ­¥_è·å–_æŒ‡å®šèŠ‚ç‚¹ä¸‹_æ‰€æœ‰_æŒ‡å®šç±»_åŠå…¶æ´¾ç”Ÿç±»_èŠ‚ç‚¹çš„_è·¯å¾„(ç±»å, èµ·å§‹èŠ‚ç‚¹)
	if _èŠ‚ç‚¹è·¯å¾„åˆ—è¡¨.is_empty():
		print_rich("[color=gray]æœªæ‰¾åˆ°ä»»ä½•èŠ‚ç‚¹[/color]")
		return

	# æ„å»ºæ ‘çŠ¶ç»“æ„ï¼šæ¯å±‚æ˜¯ { "å­èŠ‚ç‚¹å": { "_æ‰“å°": bool, "children": {} } }
	var æ ‘çŠ¶ç»“æ„ = {}

	for _èŠ‚ç‚¹è·¯å¾„ in _èŠ‚ç‚¹è·¯å¾„åˆ—è¡¨:
		var è·¯å¾„éƒ¨åˆ† = _èŠ‚ç‚¹è·¯å¾„.split("/", false)
		var å½“å‰å±‚çº§ = æ ‘çŠ¶ç»“æ„

		for i in range(è·¯å¾„éƒ¨åˆ†.size()):
			var éƒ¨åˆ† = è·¯å¾„éƒ¨åˆ†[i]
			if éƒ¨åˆ†.is_empty():
				continue

			if not å½“å‰å±‚çº§.has(éƒ¨åˆ†):
				å½“å‰å±‚çº§[éƒ¨åˆ†] = {"_æ‰“å°": false, "_è·¯å¾„": "/".join(è·¯å¾„éƒ¨åˆ†.slice(0, i+1))}
			
			# å¦‚æœæ˜¯ç›®æ ‡èŠ‚ç‚¹ï¼Œæ ‡è®°ä¸ºå¯æ‰“å°
			if i == è·¯å¾„éƒ¨åˆ†.size() - 1:
				å½“å‰å±‚çº§[éƒ¨åˆ†]["_æ‰“å°"] = true

			# è¿›å…¥ä¸‹ä¸€å±‚
			if not å½“å‰å±‚çº§[éƒ¨åˆ†].has("children"):
				å½“å‰å±‚çº§[éƒ¨åˆ†]["children"] = {}
			å½“å‰å±‚çº§ = å½“å‰å±‚çº§[éƒ¨åˆ†]["children"]

	# å½©è‰²æ‰“å°å‡½æ•°
	var æ‰“å°æ ‘ := func(å­æ ‘: Dictionary, ç¼©è¿›: String, é€’å½’è‡ªèº«: Callable):
		var é”®åˆ—è¡¨ = å­æ ‘.keys()
		é”®åˆ—è¡¨.sort()
		var æ€»æ•° := é”®åˆ—è¡¨.size()

		for i in range(æ€»æ•°):
			var é”® = é”®åˆ—è¡¨[i]
			if é”® in ["_æ‰“å°", "_è·¯å¾„", "children"]:
				continue
				
			var èŠ‚ç‚¹ä¿¡æ¯ = å­æ ‘[é”®]
			var æ˜¯æœ€å = (i == æ€»æ•° - 1)
			var å‰ç¼€ = ç¼©è¿› + ("â””â”€â”€ " if æ˜¯æœ€å else "â”œâ”€â”€ ")
			
			# å½©è‰²è¾“å‡º
			if èŠ‚ç‚¹ä¿¡æ¯.get("_æ‰“å°", false):
				print_rich(å‰ç¼€ + "[color=white]" + é”® + "[/color]")
			else:
				print_rich(å‰ç¼€ + "[color=web_gray]" + é”® + "[/color]")

			var æ–°ç¼©è¿› = ç¼©è¿› + ("    " if æ˜¯æœ€å else "â”‚   ")
			é€’å½’è‡ªèº«.call(èŠ‚ç‚¹ä¿¡æ¯.get("children", {}), æ–°ç¼©è¿›, é€’å½’è‡ªèº«)
	
	print_rich("[color=yellow]ğŸŒ³ èŠ‚ç‚¹ç»“æ„:[/color]")
	await æ‰“å°æ ‘.call(æ ‘çŠ¶ç»“æ„, "", æ‰“å°æ ‘)

	print_rich("\n[color=yellow]ğŸ§¾ æ‰€æœ‰åŒ¹é…çš„èŠ‚ç‚¹è·¯å¾„:[/color]")
	for i in range(_èŠ‚ç‚¹è·¯å¾„åˆ—è¡¨.size()):
		print_rich(" - [color=white]" + _èŠ‚ç‚¹è·¯å¾„åˆ—è¡¨[i] + "[/color]")


static func å¼‚æ­¥_ä¿å­˜ä¸º_JSONæ–‡ä»¶(ç±»å: String, æ˜¯_åœºæ™¯: bool = true, æ–‡ä»¶å_å»é™¤_åç¼€: bool = true, ä¿å­˜æ–‡ä»¶å: String = "", ä¿å­˜ç›®å½•: String = "", æ£€æŸ¥æ ¹ç›®å½•: String = "res://"):
	if ç±»å == null or ç±»å.is_empty():
		push_error("è·å–_æ‰€æœ‰æ´¾ç”Ÿç±»æ–‡ä»¶çš„_è·¯å¾„å¤±è´¥: å‚æ•°'åŸºç±»'ä¸ºnullæˆ–ç©ºå­—ç¬¦ä¸²")
		return
	if ä¿å­˜æ–‡ä»¶å == null or ä¿å­˜æ–‡ä»¶å.is_empty():
		push_error("è·å–_æ‰€æœ‰æ´¾ç”Ÿç±»æ–‡ä»¶çš„_è·¯å¾„å¤±è´¥: å‚æ•°'ä¿å­˜æ–‡ä»¶å'ä¸ºnullæˆ–ç©ºå­—ç¬¦ä¸²")
		return
	if ä¿å­˜ç›®å½• == null or ä¿å­˜ç›®å½•.is_empty():
		push_error("è·å–_æ‰€æœ‰æ´¾ç”Ÿç±»æ–‡ä»¶çš„_è·¯å¾„å¤±è´¥: å‚æ•°'ä¿å­˜ç›®å½•'ä¸ºnullæˆ–ç©ºå­—ç¬¦ä¸²")
		return

	if not DirAccess.dir_exists_absolute(ä¿å­˜ç›®å½•):
		push_error("æ–‡ä»¶å°†ä¿å­˜åˆ°çš„ç›®å½•å¹¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆè®¾ç½®è¦ä¿å­˜çš„ä½ç½®")
		return
	if ç±»å.is_empty():
		push_warning("è¯·å…ˆè®¾ç½®è¦æŸ¥æ‰¾çš„ç±»å")
		return

	var æ–‡ä»¶åˆ—è¡¨ = await å¼‚æ­¥_è·å–_æŒ‡å®šç›®å½•ä¸‹_æŒ‡å®šç±»_åŠå…¶æ´¾ç”Ÿç±»_æ–‡ä»¶çš„_è·¯å¾„(ç±»å, æ˜¯_åœºæ™¯, æ£€æŸ¥æ ¹ç›®å½•)
	if æ–‡ä»¶åˆ—è¡¨.is_empty():
		push_warning("æœªæ‰¾åˆ°å¯ä¿å­˜çš„æ–‡ä»¶")
		return

	var è·¯å¾„å­—å…¸ = {}
	for i in æ–‡ä»¶åˆ—è¡¨.size():
		var æ–‡ä»¶è·¯å¾„ = æ–‡ä»¶åˆ—è¡¨[i]
		var æ–‡ä»¶å = æ–‡ä»¶è·¯å¾„.get_file()
		if æ–‡ä»¶å_å»é™¤_åç¼€:
			æ–‡ä»¶å = æ–‡ä»¶å.get_basename()
		è·¯å¾„å­—å…¸[æ–‡ä»¶å] = æ–‡ä»¶è·¯å¾„

		if i % æ¯å¸§_æ“ä½œæ¬¡æ•° == 0:
			await HistoriaRivero.å¸§_æ›´æ–°

	var ä¿å­˜è·¯å¾„ = ä¿å­˜ç›®å½•.path_join(ä¿å­˜æ–‡ä»¶å)
	var æ–‡ä»¶ = FileAccess.open(ä¿å­˜è·¯å¾„, FileAccess.WRITE)
	if æ–‡ä»¶:
		æ–‡ä»¶.store_string(JSON.stringify(è·¯å¾„å­—å…¸, "\t"))
		æ–‡ä»¶.close()
		print("æ–‡ä»¶è·¯å¾„å­—å…¸å·²ä¿å­˜åˆ°: %s" % ä¿å­˜è·¯å¾„)
	else:
		push_error("æ— æ³•ä¿å­˜æ–‡ä»¶åˆ°: %s" % ä¿å­˜è·¯å¾„)


static func å¼‚æ­¥_è·å–_æŒ‡å®šèŠ‚ç‚¹ä¸‹_æ‰€æœ‰_æŒ‡å®šç±»_åŠå…¶æ´¾ç”Ÿç±»_èŠ‚ç‚¹çš„_è·¯å¾„(åŸºç±»å: String, èµ·å§‹èŠ‚ç‚¹: Node) -> Array[String]:
	var ç»“æœè·¯å¾„æ•°ç»„: Array[String] = []

	if not èµ·å§‹èŠ‚ç‚¹:
		push_error("èµ·å§‹èŠ‚ç‚¹ä¸º nullï¼Œè¯·æ£€æŸ¥è¾“å…¥")
		return ç»“æœè·¯å¾„æ•°ç»„

	var _èŠ‚ç‚¹æ•°å¼•ç”¨ :Array[int]= [0]

	var _éå†èŠ‚ç‚¹ := (
		func(å½“å‰èŠ‚ç‚¹: Node, é€’å½’è‡ªèº«: Callable):
			if _æ£€æŸ¥_åœºæ™¯_ç»§æ‰¿é“¾(å½“å‰èŠ‚ç‚¹, åŸºç±»å):
				var èŠ‚ç‚¹è·¯å¾„ = å½“å‰èŠ‚ç‚¹.get_path()
				ç»“æœè·¯å¾„æ•°ç»„.append(str(èŠ‚ç‚¹è·¯å¾„))

			_èŠ‚ç‚¹æ•°å¼•ç”¨[0] = _èŠ‚ç‚¹æ•°å¼•ç”¨[0] + 1
			if _èŠ‚ç‚¹æ•°å¼•ç”¨[0] % æ¯å¸§_æ“ä½œæ¬¡æ•° == 0:
				await HistoriaRivero.å¸§_æ›´æ–°

			for å­èŠ‚ç‚¹ in å½“å‰èŠ‚ç‚¹.get_children():
				await é€’å½’è‡ªèº«.call(å­èŠ‚ç‚¹, é€’å½’è‡ªèº«)
	)

	await _éå†èŠ‚ç‚¹.call(èµ·å§‹èŠ‚ç‚¹, _éå†èŠ‚ç‚¹)
	return ç»“æœè·¯å¾„æ•°ç»„


static func é»˜è®¤_ç­›é€‰å™¨_å…¨é€‰(_æ–‡ä»¶è·¯å¾„: String)->bool:
	return true


static func å¼‚æ­¥_è·å–_æŒ‡å®šç›®å½•ä¸‹_æŒ‡å®šç±»_åŠå…¶æ´¾ç”Ÿç±»_æ–‡ä»¶çš„_è·¯å¾„(åŸºç±»: String, æ˜¯_åœºæ™¯: bool = true, æ ¹ç›®å½•: String = "res://", æ•°é‡é™åˆ¶: int = -1, ç­›é€‰:Callable = é»˜è®¤_ç­›é€‰å™¨_å…¨é€‰) -> PackedStringArray:
	var _å·²è·å–æ•°é‡:= 0
	var ç»“æœ: Array[String] = []
	var æ–‡ä»¶åˆ—è¡¨: Array[String] = []

	_æ‰«æç›®å½•(æ ¹ç›®å½•, æ–‡ä»¶åˆ—è¡¨)

	for i in æ–‡ä»¶åˆ—è¡¨.size():
		var æ–‡ä»¶_è·¯å¾„ = æ–‡ä»¶åˆ—è¡¨[i]
		if (æ˜¯_åœºæ™¯ and !æ–‡ä»¶_è·¯å¾„.ends_with(".tscn")) or (!æ˜¯_åœºæ™¯ and !æ–‡ä»¶_è·¯å¾„.ends_with(".tres")):
			continue

		var èµ„æº = ResourceLoader.load(æ–‡ä»¶_è·¯å¾„)
		if not èµ„æº:
			continue

		if æ˜¯_åœºæ™¯ and èµ„æº is PackedScene:
			var å®ä¾‹ = èµ„æº.instantiate()
			if _æ£€æŸ¥_åœºæ™¯_ç»§æ‰¿é“¾(å®ä¾‹, åŸºç±»):
				if ç­›é€‰ == é»˜è®¤_ç­›é€‰å™¨_å…¨é€‰:
					ç»“æœ.append(æ–‡ä»¶_è·¯å¾„)
					_å·²è·å–æ•°é‡ += 1
				else:
					if not ç­›é€‰.call(æ–‡ä»¶_è·¯å¾„):
						continue
					ç»“æœ.append(æ–‡ä»¶_è·¯å¾„)
					_å·²è·å–æ•°é‡ += 1
					
		elif !æ˜¯_åœºæ™¯ and èµ„æº is Resource:
			if _æ£€æŸ¥_èµ„æº_ç»§æ‰¿é“¾(èµ„æº, åŸºç±»):
				if ç­›é€‰ == é»˜è®¤_ç­›é€‰å™¨_å…¨é€‰:
					ç»“æœ.append(æ–‡ä»¶_è·¯å¾„)
					_å·²è·å–æ•°é‡ += 1
				else:
					if not ç­›é€‰.call(æ–‡ä»¶_è·¯å¾„):
						continue
					ç»“æœ.append(æ–‡ä»¶_è·¯å¾„)
					_å·²è·å–æ•°é‡ += 1
		
		if _å·²è·å–æ•°é‡ >= æ•°é‡é™åˆ¶:
			break

		if i % æ¯å¸§_æ“ä½œæ¬¡æ•° == 0:
			await HistoriaRivero.å¸§_æ›´æ–°
	# if æ•°é‡é™åˆ¶ > 0: print_rich("[color=royal_blue]æœ¬æ¬¡ å¼‚æ­¥_è·å–_æŒ‡å®šç›®å½•ä¸‹_æŒ‡å®šç±»_åŠå…¶æ´¾ç”Ÿç±»_æ–‡ä»¶çš„_è·¯å¾„ å…·æœ‰æ•°é‡é™åˆ¶ï¼š%s[/color]"%æ•°é‡é™åˆ¶)
	return ç»“æœ

#endregion


#region è¾…åŠ©æ–¹æ³•

# é€’å½’æ‰«æç›®å½•
static func _æ‰«æç›®å½•(å½“å‰è·¯å¾„: String, æ–‡ä»¶åˆ—è¡¨: Array[String]):
	if æ‰«ææ—¶_å¿½ç•¥éšè—ç›®å½• and (å½“å‰è·¯å¾„.split("/") as Array).any(func(dir:String):return dir.begins_with(".")):
		return

	var _è·¯å¾„åˆ—è¡¨ := ResourceLoader.list_directory(å½“å‰è·¯å¾„)
	if not _è·¯å¾„åˆ—è¡¨:
		push_warning("æ‰§è¡Œ_æ‰«æç›®å½• å¤±è´¥: æ— æ³•æ‰“å¼€ç›®å½• æˆ– ç›®å½•ä¸ºç©º: %s" % å½“å‰è·¯å¾„)
		return

	for _è·¯å¾„: String in _è·¯å¾„åˆ—è¡¨:
		var _å®Œæ•´è·¯å¾„ := å½“å‰è·¯å¾„.path_join(_è·¯å¾„)
		if _è·¯å¾„.ends_with("/") and DirAccess.dir_exists_absolute(_å®Œæ•´è·¯å¾„):
			_æ‰«æç›®å½•(_å®Œæ•´è·¯å¾„, æ–‡ä»¶åˆ—è¡¨)
		else:
			æ–‡ä»¶åˆ—è¡¨.append(_å®Œæ•´è·¯å¾„)


# æ£€æŸ¥å¯¹è±¡çš„ç»§æ‰¿å…³ç³»ï¼ˆç”¨äºåœºæ™¯å®ä¾‹ï¼‰
static func _æ£€æŸ¥_åœºæ™¯_ç»§æ‰¿é“¾(å¯¹è±¡: Object, åŸºç±»å: String) -> bool:
	var è„šæœ¬ = å¯¹è±¡.get_script()
	#è¿™ä¸€æ®µæ²¡å¿…è¦å¯ç”¨ï¼Œå¯ç”¨ååè€Œå¯èƒ½å¯¼è‡´æœªæŒ‚è½½è„šæœ¬çš„é»˜è®¤ç±»å‹ï¼ˆå¦‚Controlï¼‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹è¢«å¿½ç•¥ã€‚
	# if not è„šæœ¬:
	#     push_error("_æ£€æŸ¥_åœºæ™¯_ç»§æ‰¿é“¾ å¤±è´¥: %s çš„ %s çš„è„šæœ¬ä¸å­˜åœ¨ï¼Œæ— æ³•æ£€æŸ¥ç»§æ‰¿é“¾ã€‚"%[(å¯¹è±¡ as Node).scene_file_path ,å¯¹è±¡])
	#     return false
	while è„šæœ¬:
		if è„šæœ¬.resource_path.ends_with("/%s.gd" % åŸºç±»å):
			return true
		if è„šæœ¬ and è„šæœ¬.has_method("get_base_script"):
			è„šæœ¬ = è„šæœ¬.get_base_script()
		else:
			break
	
	# æ£€æŸ¥åŸç”Ÿç±»ç»§æ‰¿
	var å½“å‰ç±» = å¯¹è±¡.get_class()
	while å½“å‰ç±» != "":
		if å½“å‰ç±» == åŸºç±»å:
			return true
		å½“å‰ç±» = ClassDB.get_parent_class(å½“å‰ç±»)
	
	return false


# æ£€æŸ¥èµ„æºçš„ç»§æ‰¿å…³ç³»ï¼ˆç”¨äºèµ„æºæ–‡ä»¶ï¼‰
static func _æ£€æŸ¥_èµ„æº_ç»§æ‰¿é“¾(_èµ„æº: Resource, åŸºç±»å: String) -> bool:
	# é¦–å…ˆæ£€æŸ¥è„šæœ¬ç»§æ‰¿
	var è„šæœ¬ = _èµ„æº.get_script()
	#è¿™ä¸€æ®µæ²¡å¿…è¦å¯ç”¨ï¼Œå¯ç”¨ååè€Œå¯èƒ½å¯¼è‡´æœªæŒ‚è½½è„šæœ¬çš„é»˜è®¤ç±»å‹ï¼ˆå¦‚Controlï¼‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹è¢«å¿½ç•¥ã€‚
	# if not è„šæœ¬:
	#     push_error("_æ£€æŸ¥_åœºæ™¯_ç»§æ‰¿é“¾ å¤±è´¥: %s çš„ %s çš„è„šæœ¬ä¸å­˜åœ¨ï¼Œæ— æ³•æ£€æŸ¥ç»§æ‰¿é“¾ã€‚"%[(å¯¹è±¡ as Node).scene_file_path ,å¯¹è±¡])
	#     return false
	while è„šæœ¬:
		if è„šæœ¬.resource_path.ends_with("/%s.gd" % åŸºç±»å):
			return true
		if è„šæœ¬ and è„šæœ¬.has_method("get_base_script"):
			è„šæœ¬ = è„šæœ¬.get_base_script()
	
	# æ£€æŸ¥èµ„æºæœ¬èº«çš„ç±»ç»§æ‰¿
	var _èµ„æºç±» = _èµ„æº.get_class()
	while _èµ„æºç±» != "":
		if _èµ„æºç±» == åŸºç±»å:
			return true
		_èµ„æºç±» = ClassDB.get_parent_class(_èµ„æºç±»)
	
	return false

#endregion
